<?xml version="1.0" encoding="UTF-8"?>
<WebLink xmlns="http://soap.sforce.com/2006/04/metadata">
    <fullName>Send_for_eSignature</fullName>
    <availability>online</availability>
    <displayType>button</displayType>
    <linkType>javascript</linkType>
    <masterLabel>Send for eSignature</masterLabel>
    <openType>onClickJavaScript</openType>
    <protected>false</protected>
    <url>// This button will query for all agreement templates and
// present a list for the user to choose an agreement template from.
// If there is only 1 template, no options are given and that agreement template is used.
// If there are no agreement templates, an alert is displayed.

// Written By Chris Merrill (cmerrill@adobe.com), Original version published October 2014

// Latest version available at http://j.mp/1vPHwS8

// Id of MasterObjectType. Taken from URL
var MasterObjectId = document.URL.split(&quot;/&quot;)[3];

// Try to determine ObjectType by Id Prefix
// Master Object to be used with the agreement template
// Prefix to standard object mapping definitions: http://j.mp/1BY2cYY
//
var MasterObjectType;
switch ( MasterObjectId.substring(0, 3) ) {
case &apos;001&apos;: MasterObjectType = &apos;Account&apos;; break;
case &apos;003&apos;: MasterObjectType = &apos;Contact&apos;; break;
case &apos;005&apos;: MasterObjectType = &apos;User&apos;; break;
case &apos;006&apos;: MasterObjectType = &apos;Opportunity&apos;; break;
case &apos;800&apos;: MasterObjectType = &apos;Contract&apos;; break;
case &apos;500&apos;: MasterObjectType = &apos;Case&apos;; break;
case &apos;00Q&apos;: MasterObjectType = &apos;Lead&apos;; break;

// If you are using a custom object, or one not listed above,
// Change the default below
default: MasterObjectType = &quot;Opportunity&quot;;
} //&lt;/switch

// Salesforce.com Javascript libraries
{!REQUIRESCRIPT( &quot;/soap/ajax/31.0/connection.js&quot; )}
{!REQUIRESCRIPT( &quot;/soap/ajax/31.0/apex.js&quot; )}

var oppstage = &quot;{!Opportunity.StageName}&quot;;
var wonreason =  &quot;{!Opportunity.Primary_Won_Reason__c}&quot;;
var secreason = &quot;{!Opportunity.Secondary_Won_Reason__c}&quot;; 
var terreason = &quot;{!Opportunity.Tertiary_Won_Reason__c}&quot;;
var winfactors = &quot;{!Opportunity.Differentiating_Win_Factors__c}&quot;; 
var incumbent = &quot;{!Opportunity.Incumbent__c}&quot;;
var competitor = &quot;{!Opportunity.Competitor_s__c}&quot;;
var oppid = &quot;{!Opportunity.Id}&quot;;

var agreementstatus = sforce.connection.query( &quot;select id,ECHOSIGN_DEV1__STATUSVISIBLE__C from echosign_dev1__SIGN_Agreement__c where ECHOSIGN_DEV1__OPPORTUNITY__C = &apos;&quot;+oppid+&quot;&apos; and ECHOSIGN_DEV1__STATUSVISIBLE__C IN (&apos;Draft&apos;,&apos;Pre-Send&apos;,&apos;Out for Signature&apos;,&apos;Waiting for Counter-Signature&apos;,&apos;Send in Progress&apos;,&apos;Waiting for Counter-Approval&apos;,&apos;Out for Approval&apos;,&apos;Created&apos;)&quot; );

// Get array of related Agreement Templates
aggrecords = agreementstatus.getArray( &quot;records&quot; );

if( aggrecords.length &gt;= 1) {
alert(&apos;There is already an open Adobe Agreement against this opportunity&apos;);}

else
{
if (oppstage == &apos;Awareness&apos;) 
alert(&apos;eSignature is not available for opportunities that are in the Awareness stage. Please move this opportunity beyond Awareness before using eSignature&apos;); 

else if (oppstage == &apos;Closed Lost&apos; || oppstage == &apos;Closed Won&apos;)
alert(&apos;eSignature is not available for Closed opportunities&apos;);


else
{
if (wonreason == &apos;&apos; || secreason == &apos;&apos; || terreason == &apos;&apos; || winfactors == &apos;&apos; || incumbent == &apos;&apos; || competitor == &apos;&apos; )
alert(&apos;Please fill in all the Closed Won Reason fields to generate a eSignature request - Primary Won Reason, Secondary Won Reason, Territory Won Reason, Differentiating Win Factors, Competitor and Incumbent&apos;);
else 
{ 

var userregion = &quot;{!TEXT($User.User_Region__c)}&quot;;
var usercountry = &quot;{!$User.Country}&quot;;
var userchannel = &quot;{!TEXT($User.Channel__c)}&quot;;

// Find Agreement templates related to MasterObjectType
// Change the query as needed to add additional filters for the agreement templates

if(userchannel == &apos;Partners&apos; || userchannel == &apos;Carrier&apos;)
userregion = &apos;Partner&apos;;

else
{
if(usercountry == &apos;India&apos;)
userregion = &apos;EMEA&apos;;
}
//alert(userchannel);
//alert(userregion);
var agreements = sforce.connection.query( &quot;SELECT Id, Name FROM echosign_dev1__Agreement_Template__c WHERE Name LIKE &apos;&quot;+userregion+&quot;%&apos; and echosign_dev1__Master_Object_Type__c = &apos;&quot; + MasterObjectType + &quot;&apos;&quot; );

// Get array of related Agreement Templates
records = agreements.getArray( &quot;records&quot; );

// If there are zero templates, alert user and do nothing
if( records.length == 0) {

alert(&apos;There are no agreement templates to choose from.&apos;);

// If there is ONE template, there is no need to choose one. Navigate user forward
} else if(records.length == 1) {

location.href = &apos;/apex/echosign_dev1__AgreementTemplateProcess?masterId=&apos; + MasterObjectId + &apos;&amp;TemplateId=&apos; + records[0].Id;

// If there are more than one, Let the user choose which template to user
} else {



// Declare HTML string for popup
var agreementListHtml = &apos;&lt;br /&gt;&apos;;

// Build HTML to show in modal.
for (var i=0; i&lt; records.length; i++) {

agreementListHtml += &apos;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;h3&gt;&lt;a href=&quot;/apex/echosign_dev1__AgreementTemplateProcess?masterId=&apos; + MasterObjectId + &apos;&amp;TemplateId=&apos; + records[i].Id + &apos;&quot; title=&quot;&apos; + records[i].Id + &apos;&quot;&gt;&apos; + records[i].Name + &apos;&lt;/a&gt;&lt;/h3&gt;&apos;;


if( i&lt; records.length ) {

agreementListHtml += &apos;&lt;br /&gt;&lt;br /&gt;&apos;;

} // &lt;/if

} // &lt;/for

// HTML for close button that is included at the bottom of the modal
var closeButtonHtml = &quot;&lt;p style=&apos;text-align:right;&apos;&gt;&lt;button class=&apos;btn&apos; onclick=&apos;window.parent.sd.hide(); return false;&apos;&gt;&amp;nbsp;Close&amp;nbsp;&lt;/button&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/p&gt;&quot;;

// Use salesforce.com native SimpleDialog() to show modal
var sd = new SimpleDialog( &quot;Agreement Template Chooser&quot; + Math.random(), false );
sd.setTitle( &quot;Choose an Agreement Template&quot; );
sd.createDialog();
window.parent.sd = sd;
sd.setContentInnerHTML( agreementListHtml + closeButtonHtml );
sd.show();
} // &lt;/else
}
}
}</url>
</WebLink>
