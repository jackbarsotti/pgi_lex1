<?xml version="1.0" encoding="UTF-8"?>
<WebLink xmlns="http://soap.sforce.com/2006/04/metadata">
    <fullName>Update_from_NetSuite</fullName>
    <availability>online</availability>
    <displayType>button</displayType>
    <linkType>javascript</linkType>
    <masterLabel>Update from NetSuite</masterLabel>
    <openType>onClickJavaScript</openType>
    <protected>false</protected>
    <url>var Celigo = {};
Celigo.SFDC = (function(){ //private members
    function AccountSyncManager(){
      //instance vars
        var that = this;
		var retries = 0;
		var maxRetries = 20;
                //methods
		this.getURLParameter = function(_url, _name){ //String
                    var regexS;
		    var regex;
		    var results;
                     _name = _name.replace(/[\[]/, &quot;\\\[&quot;).replace(/[\]]/, &quot;\\\]&quot;);
		    regexS = &quot;[\\?&amp;]&quot; + _name + &quot;=([^&amp;#]*)&quot;;
                    regex = new RegExp(regexS);
                    results = regex.exec(_url);
                    if (results === null) {
		        return &quot;&quot;;
		    }
		    else {
		        return results[1];
		    }
                   };
		
        this.triggerNsSync = function(){
			var a = new sforce.SObject(&quot;Account&quot;); 
			a.id = &quot;{!Account.Id}&quot;; 
			a.NetSuite_Pull__c = &apos;true&apos;;
			a.Celigo_Update__c = &apos;true&apos;;
			return sforce.connection.update([a]); 
        };
        
        this.openPopup = function(){
        
            var top = screen.height - (screen.height * .5) - 100;
            var left = screen.width - (screen.width * .5) - 187;
            var params = &apos;dependent = yes,resizable=false,scrollbars=false,toolbar=false,menubar=false,location=false,status=true,directories=false,width=375,height=160,top=&apos;;
            params += top.toString();
            params += &apos;,left=&apos; + left.toString() + &apos;\&apos;&apos;;
            
            return window.open(&apos;/apex/account_status?whence=&apos;+&quot;{!Account.Id}&quot;, &apos;NetSuite_Synchronization&apos;, params);
        };
        
        this.checkSyncStatus = function(){
            var result = sforce.connection.query(&quot;select Id, NetSuite_Pull__c from Account where Id = &apos;&quot;+ &quot;{!Account.Id}&quot; +&quot;&apos;&quot;, {
                onSuccess: function(result){
                    var records = result.getArray(&apos;records&apos;);
                    if (records[0].NetSuite_Pull__c === &apos;false&apos;) 
						window.location.href = window.location.href;
					else if(retries &lt; maxRetries){
						retries++;
						window.setTimeout(that.checkSyncStatus, 5000);
					}
                },
                onFailure: function(error){
                    alert(&apos;An error has occurred, please contact your Celigo representative: &apos; + error);
                }
            });
        };
        
    }
    return { //public members
        main: function(){
            try {
                {!REQUIRESCRIPT(&quot;/soap/ajax/13.0/connection.js&quot;)}
var inProg= sforce.connection.query(&quot;select Id, NetSuite_Pull__c, NetSuite_Push__c from Account where Id = &apos;&quot;+ &quot;{!Account.Id}&quot; + &quot;&apos;&quot;);
                        var records = inProg.getArray(&apos;records&apos;);
                        if (records[0].NetSuite_Pull__c === &apos;true&apos; || records[0]. NetSuite_Push__c === &apos;true&apos;) 
                            alert(&quot;Sync already in progress.&quot;);
else {
                var sosm = new AccountSyncManager();
                sosm.triggerNsSync();
                sosm.openPopup();
                window.setTimeout(sosm.checkSyncStatus, 5000);
}
            } 
            catch (e) {
                alert(&apos;An error has occurred, please contact your Celigo representative: &apos; + e.name + &apos; - &apos; + e.message);
            }
        }
    }
})();

Celigo.SFDC.main();</url>
</WebLink>
