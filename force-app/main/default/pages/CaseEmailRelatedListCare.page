<apex:page standardController="Case" extensions="CaseEmailRelatedListController" sidebar="false" showHeader="false">
    <apex:includeScript value="/support/console/41.0/integration.js" />
  
  
    
    <apex:form >


<script>
   function openWin(divName, textName){
    var divText = document.getElementById(divName).innerText;
    
    if(divText.length == 0)
    {
    divText =  "<pre>" +  document.getElementById(textName).innerText + "</pre>";
    }
    var myWindow = window.open('','','width=600,height=500');
    var doc = myWindow.document;
    doc.open();
    doc.write(divText);
    doc.close();
    }
    var url;
    var subject;
    function myNavigation(subjectVar, myVar) {
        url = myVar;
        subject = subjectVar;
        if (sforce.console.isInConsole()) {
            if (url.indexOf('?') > 0) {
                url += '&inConsole=true';
            } else {
                url += '?inConsole=true';
            }
            //Open a new primary tab with the salesforce.com home page in it
            sforce.console.getEnclosingPrimaryTabId(openSubtab);
            // sforce.console.openPrimaryTab(null, myVar, true, subject);
        } else {
            var win = window.open(myVar, '_blank');
            win.focus();
        }
    }
    var openSubtab = function openSubtab(result) {
        //Now that we have the primary tab ID, we can open a new subtab in it
        console.log(result, 'result');
        console.log(result.id, 'result.id');
        var primaryTabId = result.id;
        console.log(url);
        sforce.console.openSubtab(primaryTabId, url, true,
                                  subject, null, openSuccess, subject);
    };
    var openSuccess = function openSuccess(result) {
        //Report whether we succeeded in opening the subtab
        console.log(result);
        if (result.success == true) {
            
        } else {
            sforce.console.openPrimaryTab(null, url, true, subject);
        }
    };
    </script>
    
    
    

        <apex:pageblock id="CaseList">

            <div style="margin-left: 30%;">
                <a href="#" class="btn" onclick="myNavigation('New Email', '/apex/SendAnEmail?id={!objCase.Id}'); return false;">
                    Send an Email
                </a>

            </div>

            <br/>
            
            
<apex:variable value="Hide Preview" var="firstRow"/>
<apex:variable value="" var="HideFirstRow"/>

            <apex:pageBlockTable value="{!emailMsgLst}" var="mail" rendered="{!NOT(ISNULL(emailMsgLst))}" >

                <apex:column HeaderValue="Details" width="60" style="width: 225px;background-color:#f2f3f3;border-width:1px;border-color:#e0e3e5;" >
 

   

   


                        
<a href="#"  style="color:#015ba7;text-decoration:none;"  onclick="if(this.innerHTML =='Hide Preview') { this.innerHTML = 'Show Preview';document.getElementsByClassName('preview-{!mail.id}')[0].style.display = 'none'; } else { this.innerHTML = 'Hide Preview';document.getElementsByClassName('preview-{!mail.id}')[0].style.display = ''; }">{!firstRow}</a>
                        
     <apex:variable var="firstRow" value="Show Preview"/>
     
     
                              &nbsp;|&nbsp;
                        
                        
                           <a href="#" style="color:#015ba7;text-decoration:none;" onclick="myNavigation('{!HTMLENCODE(mail.Subject)}', '/apex/OutboundEmailMessages?emailMsgId={!mail.Id}&ObjcaseId={!objCase.Id}'); return false;">
                      Details
                    </a>
                    
                              
                    &nbsp;|&nbsp;
                                         
                    <a href="#" style="color:#015ba7;text-decoration:none;" onclick="openWin('html-{!mail.id}','text-{!mail.id}');">
                      View HTML
                    </a>
                                         
                    
                 </apex:column>   
        <apex:column HeaderValue="Actions" width="60" style="width: 175px;background-color:#f2f3f3;border-width:1px;border-color:#e0e3e5;" >
           
                        
                    <a href="#" style="color:#015ba7;text-decoration:none;" onclick="myNavigation('Reply', '/apex/SendAnEmail?replyMailId={!mail.Id}&id={!objCase.Id}'); return false;">
                        Reply
                    </a>

                    &nbsp;|&nbsp;

                    <a href="#" style="color:#015ba7;text-decoration:none;" onclick="myNavigation('Reply All', '/apex/SendAnEmail?replyMailId={!mail.Id}&id={!objCase.Id}&toAll=true'); return false;">
                        To All
                    </a>
                    &nbsp;|&nbsp;

                    <a href="#" style="color:#015ba7;text-decoration:none;" onclick="myNavigation('Forward', '/apex/SendAnEmail?fwdMailId={!mail.Id}&isFwd=true&id={!objCase.Id}'); return false;">
                        Forward
                    </a>


                </apex:column>
             
                <apex:column headerValue="Status" value="{!mail.Status}" style="background-color:#f2f3f3;border-width:1px;border-color:#e0e3e5;width:50px"  />
                <apex:column headerValue="Subject" style="background-color:#f2f3f3;border-width:1px;border-color:#e0e3e5;" >         
                      {!mail.Subject}
                </apex:column>


                <apex:column headerValue="Email Address" value="{!mail.ToAddress}"  style="background-color:#f2f3f3;border-width:1px;border-color:#e0e3e5;"  />

                <apex:column headerValue="Message Date" value="{!mail.MessageDate}" style="background-color:#f2f3f3;border-width:1px;border-color:#e0e3e5;;width:100px"   />
                
                
   <apex:column headerValue="Attachments" style="background-color:#f2f3f3;border-width:1px;border-color:#e0e3e5;width:50px" >
                    <apex:outputPanel rendered="{!mail.HasAttachment}">
                        <apex:image height="12px" width="50px" url="https://image.flaticon.com/icons/svg/1507/1507585.svg" />
                    </apex:outputPanel>
                </apex:column>

                <apex:column styleClass="preview-{!mail.id}"  style="display:{!HideFirstRow}" headerValue="Email Message" value="{!mail.TextBody}"  colspan="7"  breakBefore="true" />
           
         
                
                 <apex:column colspan="7"  breakBefore="true" style="display:none">
                          <apex:variable var="HideFirstRow" value="none"/> /* Must be after mail preview */
                 <div id="text-{!mail.id}" style="display:none">{!mail.TextBody}</div>
                 </apex:column>
                 
                 
                 <apex:column colspan="7"  breakBefore="true" style="display:none">
                 <div id="html-{!mail.id}" style="display:none">{!mail.HTMLBody}</div>
                 </apex:column>
               
               
               
            </apex:pageBlockTable>

            <apex:outputLabel value="No records to display" rendered="{!(ISNULL(emailMsgLst))}" styleClass="noRowsHeader"></apex:outputLabel>

        </apex:pageblock>

    </apex:form>
    <script>
        var url;
        var subject;
        function myNavigation(subjectVar, myVar) {
            url = myVar;
            subject = subjectVar;
            if (sforce.console.isInConsole()) {
                if (url.indexOf('?') > 0) {
                    url += '&inConsole=true';
                } else {
                    url += '?inConsole=true';
                }
                //Open a new primary tab with the salesforce.com home page in it
                sforce.console.getEnclosingPrimaryTabId(openSubtab);
                // sforce.console.openPrimaryTab(null, myVar, true, subject);
            } else {
                var win = window.open(myVar, '_blank');
                win.focus();
            }
        }
        var openSubtab = function openSubtab(result) {
            //Now that we have the primary tab ID, we can open a new subtab in it
            console.log(result, 'result');
            console.log(result.id, 'result.id');
            var primaryTabId = result.id;
            console.log(url);
            sforce.console.openSubtab(primaryTabId, url, true,
                subject, null, openSuccess, subject);
        };
        var openSuccess = function openSuccess(result) {
            //Report whether we succeeded in opening the subtab
            console.log(result);
            if (result.success == true) {

            } else {
                sforce.console.openPrimaryTab(null, url, true, subject);
            }
        };
    </script>
</apex:page>